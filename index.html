<!DOCTYPE html>
<html>
<!--
This is an example app that demonstrates how to control an
RFduino RFD22102 board using BLE (Bluetooth Low Energy).

Please note that this example requires an RFduino RFD22102 plus
and RFduino RGB LED Button shield (RFD22122). In addition, an
RFduino USB shield (RFD22121) is needed for programming the
RFduino from a PC orÂ Mac.
-->
<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no
		initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>BDWBot</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<style>
	div {
		margin: 10px 0px;
	}
	button {
		margin: 5px 0px;
	}
	.lead {
		font-weight: bold;
	}
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>

	<script src="cordova.js"></script>
	<script src="libs/jquery/jquery.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/rfduinoble/rfduinoble.js"></script>
	<script type="text/javascript" src="graph.js"></script>

</head>

<body>

	<!--<header>
		<button class="back" onclick="history.back()">
			<img src="ui/images/arrow-left.svg" />
		</button>

		<img class="logotype" src="ui/images/logo.svg" alt="Evothings" />

		<button class="menu" onclick=""><img src="ui/images/menu.svg" /></button>
	</header>-->
	<div id="control_panel">
	<center><h1>Moe</h1><p>"Hello my name is Moe, the digital monitor." How may I help you today?<center>

	<p id="info" class="lead">Initializing...</p>

	<center><button type="button" class="yellow" onclick="app.connect()">
		Connect
	</button>
	<button type="button" class="green" onclick="showInstructions()">
		How to use
	</button>
	<button type="button" class="blue" onclick="showFace()">
		Show Face</button>
	</center>

	<!--<br />

	<button type="button" class="blue" onclick="app.ledOn()">
		Turn Right
	</button>

	<button type="button" class="charcoal" onclick="app.ledOff()">
		Turn Left
	</button>
	
	<br>-->
	
	<center>
	
	</center>
	
	<style>
		.large_combobox  {
			width: 50%;
			height: 25%;
			line-height: 100%;
			font-size: 100%;
			padding: 0 0 0 2px;
		}
	</style>
	
	<select id="destination" class='large_combobox'>
    </select>
	<button type="button" class="charcoal" onclick="route_directions()">
		Navigate!
	</button>
	
	

	
	<!--<h2>Instructions</h2>
	<p>Hello, I am the BDWbot. Let me help show you around the Brown Design Workshop! I can help answer questions or you can use Skype to call a mentor.</p>
	-->
	</div>

	<head>
		<link rel="stylesheet" type="text/css" href="baymax.css">
	</head>
	
	<div id="baymax" class="baymax" >
	</div>
	<button class = "baymax_close" id="baymax_close" onclick="showFace()">X</button>

	<p  hidden id="instructions" style="width: 100%; height: 100%;">
	Hello, I am the BDWbot. Let me help show you around the Brown Design Workshop! I can help answer questions or you can use Skype to call a mentor.
	</p>
	<button hidden class = "baymax_close" id="instructions_close" onclick="showInstructions()">X</button>

	
	
	<!-- TODO: Image is missing.
	<p><img src="RFduino_Image.png" style="max-height:30%;" /></p>
	-->

	<!-- JavaScript code for the app -->

	<script>
		
	// Short name for RFduino BLE library.
	var rfduinoble = evothings.rfduinoble;

	// Application object.
	var app = {};

	// Connected device.
	app.device = null;

	$("#baymax").hide();
	$("#baymax_close").hide()
	
	showFace = function()
	{
		$("#baymax").toggle();
		$("#control_panel").toggle();
		$("#baymax_close").toggle();
		$('body').toggleClass("bay_background");
		$('#instructions').hide();
		hyper.log("Baymax Shown");
	}
	
	showInstructions = function()
	{
		$("#instructions").toggle();
		$("#instructions_close").toggle();
		hyper.log("Instructions Shown");
	}
	
	showFace();
	//
	$("#baymax").on('click', showFace);
	
	//$(document).idle({onIdle:showFace(), onActive:showFace(), idle: 3000});

	// Turn on LED.
	app.ledOn = function()
	{
	    var data = new Uint8Array([1]);
		data[0] = 108;
		app.device && app.device.writeDataArray(data);
	};

	// Turn off LED.
	app.ledOff = function()
	{
	    var data = new Uint8Array([1]);
		data[0] = 114;
		app.device && app.device.writeDataArray(data);
	};

	app.showMessage = function(info)
	{
		document.getElementById("info").innerHTML = info;
	};

	// Called when BLE and other native functions are available.
	app.onDeviceReady = function()
	{
		app.showMessage('Press the yellow button to connect');
	};

	app.connect = function()
	{
		console.log("close");
		rfduinoble.close();

		// Wait 500 ms for close to complete before connecting.
	 	setTimeout(function()
		{
			console.log("connecting");
			app.showMessage("Connecting...");
			rfduinoble.connect(
				"BDWBot",
				function(device)
				{
					console.log("connected");
					app.showMessage("Connected");
					app.device = device;
				},
				function(errorCode)
				{
					app.showMessage("Connect error: " + errorCode);
				});
			},
			500);
	};

	
	app.startReading = function()
	{
		hyper.log('Enabling notifications...');

		// Turn notifications on.
		app.write(
			'writeDescriptor',
			'BDWBot',
			app.descriptorNotification,
			new Uint8Array([1,0]));

		// Start reading notifications.
		evothings.ble.enableNotification(
			'BDWBot',
			app.characteristicRead,
			function(data)
			{
				console.log('Active');
				console.log("READING DATA:" + data);
				//app.drawLines([new DataView(data).getUint16(0, true)]);
			},
			function(errorCode)
			{
				hyper.log('enableNotification error: ' + errorCode);
			});
	};
	
	// When the app is fully loaded the "deviceready" event is triggered.
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(app.onDeviceReady) },
		false);
	
	
	//jQuery.getScript('jquery.idle.js',
	//	function(){
	//		$(document).idle(inside);
	//	}
	//);

	
	/* This list should store all nodes in counterclockwise order. This way it knows how to get to each node.*/	
	/*This list should store the distance to each node from each node. T*/
	var map = {'a':{'b':3,'c':1},'b':{'a':2,'c':1},'c':{'a':4,'b':1}};
		
	/*This populates the destination box with all the keys from map.*/
	var options = $("#destination");
	$.each(Object.keys(map), function() {
		options.append($("<option />").text(this)); 
	});

	var current_point = 'a';
	
	function route(){
		var src = current_point;
		//var destination = $('#destination').find(":selected").val(this).text();
		console.log(destination);
		var mylist = document.getElementById('destination');
		var destination;
		if(mylist == null){
			destination = 'b';
		} else {
			destination = mylist.options[mylist.selectedIndex].text;
		}
		var graph = new Graph(map);
		var path = graph.findShortestPath(src, destination);
		
		return path;
	}
	
	function custom_index(array, item){
		array = array[0];
		for(var i = 0; i < array.length; i++){
			console.log("Finding Index: " + array[i]);
			if(array[i] == item){
				return i;
			}
		}
		console.log("ERROR");
		return -1;
	}

	function route_directions(){
		var adjaceny_list = {'a': ['b', '\0', 'c'], 'b': ['a', '\0', 'c'], 'c' : ['a', '\0', 'b']};
		var path = route();
		var directions = [];
		var old_point = null;
		console.log("ROUTING");
		var current_point = path[0];
		console.log('starting point: ' + current_point);
		for(var i = 1; i < path.length; i++){
			console.log("Adjaceny List");
			var neighbors = adjaceny_list[current_point]; //The bug is here but I can't find it...
			console.log("Console logs: " + path[i]);
			console.log("NEIGHBORS" + neighbors);
			//console.log("Path: " + neighbors[2]); 
			var next_dir = custom_index([adjaceny_list[current_point]], path[i]);
			if(next_dir == -1){
				console.log("ERROR: Adjaceny list does not match returned path");
				//return;
			}
			if(old_point == null){
				next_dir -= old_point;
				next_dir = (next_dir + 4) % 4;
			}
			directions.push(next_dir);
			current_point = next_dir;
		}
		if(directions.length == 0){
			console.log("not returning directions");
			return; //No directions
		}
		console.log("Directions");
		console.log(directions);

		var data = new Uint8Array(directions.length);
		for(var i = 0; i < data.length; i++){
			data[i] = directions[i] + 48;
		}
		app.device && app.device.writeDataArray(data);
		return directions;
	}
	
	app.connect();
	
	</script>
</body>
</html>
