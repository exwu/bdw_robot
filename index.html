<!DOCTYPE html>
<html>
<!--
This is an example app that demonstrates how to control an
RFduino RFD22102 board using BLE (Bluetooth Low Energy).

Please note that this example requires an RFduino RFD22102 plus
and RFduino RGB LED Button shield (RFD22122). In addition, an
RFduino USB shield (RFD22121) is needed for programming the
RFduino from a PC orÂ Mac.
-->
<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no
		initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>RFduino LED On/Off</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<!--<head>
	<link rel="stylesheet" type="text/css" href="baymax.css">
	</head>
	<div class="baymax"></div>-->
	
	<style>
	div {
		margin: 10px 0px;
	}
	button {
		margin: 5px 0px;
	}
	.lead {
		font-weight: bold;
	}
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>

	<!--<script src="cordova.js"></script>-->
	<script src="libs/jquery/jquery.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/rfduinoble.js"></script>
	<script>
		$.getScript("https://raw.githubusercontent.com/exwu/bdw_robot/gh-pages/libs/evothings/arduinoble/arduinoble.js");
	</script>

</head>

<body>

	<h1>Swivcam</h1>

	<p id="info" class="lead">Initializing...</p>

	<button type="button" class="yellow" onclick="app.connect()">
		Connect
	</button>

	<br />

	<button type="button" class="blue" onclick="app.ledOn()">
		Turn Right
	</button>

	<button type="button" class="charcoal" onclick="app.ledOff()">
		Turn Left
	</button>

	<h2>Instructions</h2>
	<p>This turns the camera left and right. It allows the user to turn the camera left or right during skype conferencing.</p>

	<!-- TODO: Image is missing.
	<p><img src="RFduino_Image.png" style="max-height:30%;" /></p>
	-->

	<!-- JavaScript code for the app -->

	<script>
	
	// Load library EasyBLE.
	evothings.loadScript('libs/evothings/easyble/easyble.js');

	/**
	 * @namespace
	 * @author Mikael Kindborg
	 * @description <p>Functions for communicating with an Arduino BLE shield.</p>
	 * <p>It is safe practise to call function {@link evothings.scriptsLoaded}
	 * to ensure dependent libraries are loaded before calling functions
	 * in this library.</p>
	 *
	 * @todo This is a very simple library that has only write capability,
	 * read and notification functions should be added.
	 *
	 * @todo Add function to set the write characteristic UUID to make
	 * the code more generic.
	 */
	evothings.arduinoble = {};

	;(function()
	{
		// Internal functions.
		var internal = {};

		/**
		 * Stop any ongoing scan and disconnect all devices.
		 * @public
		 */
		evothings.arduinoble.close = function()
		{
			evothings.easyble.stopScan();
			evothings.easyble.closeConnectedDevices();
		};

		/**
		 * Called when you've connected to an Arduino BLE shield.
		 * @callback evothings.arduinoble.connectsuccess
		 * @param {evothings.arduinoble.ArduinoBLEDevice} device -
		 * The connected BLE shield.
		 */

		/**
		 * Connect to a BLE-shield.
		 * @param deviceName BLE name if the shield.
		 * @param {evothings.arduinoble.connectsuccess} success -
		 * Success callback: success(device)
		 * @param {function} fail - Error callback: fail(errorCode)
		 * @example
		 * evothings.arduinoble.connect(
		 *   'arduinoble', // Name of BLE shield.
		 *   function(device)
		 *   {
		 *     console.log('connected!');
		 *     device.writeDataArray(new Uint8Array([1]));
		 *     evothings.arduinoble.close();
		 *   },
		 *   function(errorCode)
		 *   {
		 *     console.log('Error: ' + errorCode);
		 *   });
		 * @public
		 */
		evothings.arduinoble.connect = function(deviceName, success, fail)
		{
			evothings.easyble.startScan(
				function(device)
				{
					if (device.name == deviceName)
					{
						evothings.easyble.stopScan();
						internal.connectToDevice(device, success, fail);
					}
				},
				function(errorCode)
				{
					fail(errorCode);
				});
		};

		/**
		 * Connect to the BLE shield.
		 * @private
		 */
		internal.connectToDevice = function(device, success, fail)
		{
			device.connect(
				function(device)
				{
					// Get services info.
					internal.getServices(device, success, fail);
				},
				function(errorCode)
				{
					fail(errorCode);
				});
		};

		/**
		 * Read all services from the device.
		 * @private
		 */
		internal.getServices = function(device, success, fail)
		{
			device.readServices(
				null, // null means read info for all services
				function(device)
				{
					internal.addMethodsToDeviceObject(device);
					success(device);
				},
				function(errorCode)
				{
					fail(errorCode);
				});
		};

		/**
		 * Add instance methods to the device object.
		 * @private
		 */
		internal.addMethodsToDeviceObject = function(device)
		{
			/**
			 * Object that holds info about an Arduino BLE shield.
			 * @namespace evothings.arduinoble.ArduinoBLEDevice
			 */

			/**
			 * @function writeDataArray
			 * @description Write data to an Arduino BLE shield.
			 * @param {Uint8Array} uint8array - The data to be written.
			 * @memberof evothings.arduinoble.ArduinoBLEDevice
			 * @instance
			 * @public
			 */
			device.writeDataArray = function(uint8array)
			{
				device.writeCharacteristic(
					// TODO: Make this possible to set.
					'713d0003-503e-4c75-ba94-3148f18d941e',
					uint8array,
					function()
					{
						console.log('writeCharacteristic success');
					},
					function(errorCode)
					{
						console.log('writeCharacteristic error: ' + errorCode);
					});
			};
		};
	})();

	
	
	// Short name for RFduino BLE library.
	var rfduinoble = evothings.rfduinoble;

	// Application object.
	var app = {};

	// Connected device.
	app.device = null;

	// Turn on LED.
	app.ledOn = function()
	{
	    var data = new Uint8Array([1]);
		data[0] = 108;
		app.device && app.device.writeDataArray(data);
	};

	// Turn off LED.
	app.ledOff = function()
	{
	    var data = new Uint8Array([1]);
		data[0] = 114;
		app.device && app.device.writeDataArray(data);
	};

	app.showMessage = function(info)
	{
		document.getElementById("info").innerHTML = info;
	};

	// Called when BLE and other native functions are available.
	app.onDeviceReady = function()
	{
		app.showMessage('Press the yellow button to connect');
	};

	app.connect = function()
	{
		console.log("close");
		rfduinoble.close();

		// Wait 500 ms for close to complete before connecting.
		setTimeout(function()
		{
			console.log("connecting");
			app.showMessage("Connecting...");
			rfduinoble.connect(
				"Holo-Timer",
				function(device)
				{
					console.log("connected");
					app.showMessage("Connected");
					app.device = device;
				},
				function(errorCode)
				{
					app.showMessage("Connect error: " + errorCode);
				});
			},
			500);
	};

	// When the app is fully loaded the "deviceready" event is triggered.
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(app.onDeviceReady) },
		false);
	</script>
</body>
</html>
